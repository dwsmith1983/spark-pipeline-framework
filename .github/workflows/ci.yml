name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Detect what changed to skip tests for docs-only PRs
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - '**/*.scala'
              - '**/*.sbt'
              - 'project/**'
              - 'build.sbt'
              - '.github/workflows/**'

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 17
          cache: sbt

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      # Scalafmt: Formatting (whitespace, indentation, import order)
      - name: Check formatting (scalafmt)
        run: sbt scalafmtCheckAll

      # Scalastyle: Style rules (naming, complexity, method length)
      - name: Check style (scalastyle)
        run: sbt scalastyle

      # Scalafix: Semantic linting (unused imports/vars, dangerous patterns)
      - name: Check semantic rules (scalafix)
        run: sbt "scalafixAll --check"

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: changes
    # Skip for release-please PRs and docs-only changes
    if: ${{ !startsWith(github.head_ref, 'release-please') && needs.changes.outputs.code == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 17
          cache: sbt

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      # Restore NVD database from main branch cache
      - name: Restore OWASP NVD Database
        uses: actions/cache/restore@v5
        with:
          path: .owasp-data
          key: owasp-nvd-v1
          restore-keys: |
            owasp-nvd-

      # OWASP Dependency Check: Scan dependencies for known CVEs
      # Requires NVD API key (free): https://nvd.nist.gov/developers/request-an-api-key
      # Suppression file: dependency-check-suppressions.xml (configured in build.sbt)
      - name: OWASP Dependency Check
        continue-on-error: true
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          if [ -n "$NVD_API_KEY" ]; then
            sbt -Danalyzer.nist.nvd.api.key="$NVD_API_KEY" \
                dependencyCheckListSettings \
                dependencyCheckAggregate
          else
            echo "::warning::NVD_API_KEY not configured. Add secret to enable vulnerability scanning."
            echo "Register for free API key at: https://nvd.nist.gov/developers/request-an-api-key"
            exit 1
          fi

      - name: Upload OWASP report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: owasp-report
          path: target/scala-*/dependency-check-report.html
          retention-days: 30

      # Only save cache on main to avoid PR-level caches
      - name: Save OWASP NVD Database
        uses: actions/cache/save@v5
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          path: .owasp-data
          key: owasp-nvd-v1

  test-spark3:
    name: Test (Spark 3 / Scala 2.12)
    runs-on: ubuntu-latest
    needs: [lint, changes]
    # Skip for release-please PRs and docs-only changes
    if: ${{ !startsWith(github.head_ref, 'release-please') && needs.changes.outputs.code == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 17
          cache: sbt

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      - name: Run tests with coverage
        run: sbt coverage "project core2_12" test "project runtimespark32_12" test "project runnerspark32_12" test "project examplespark32_12" test coverageReport

      - name: Check coverage minimum
        run: sbt "project core2_12" coverageAggregate

  test-spark3-scala213:
    name: Test (Spark 3 / Scala 2.13)
    runs-on: ubuntu-latest
    needs: [lint, changes]
    # Skip for release-please PRs and docs-only changes
    if: ${{ !startsWith(github.head_ref, 'release-please') && needs.changes.outputs.code == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 17
          cache: sbt

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      - name: Run tests with coverage
        run: sbt coverage "project core" test "project runtimespark3" test "project runnerspark3" test "project examplespark3" test coverageReport

      - name: Check coverage minimum
        run: sbt "project core" coverageAggregate

  test-spark4:
    name: Test (Spark 4 / Scala 2.13)
    runs-on: ubuntu-latest
    needs: [lint, changes]
    # Skip for release-please PRs and docs-only changes
    if: ${{ !startsWith(github.head_ref, 'release-please') && needs.changes.outputs.code == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 17
          cache: sbt

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      - name: Run tests with coverage
        run: sbt coverage "project core" test "project runtimespark4" test "project runnerspark4" test "project examplespark4" test coverageReport

      - name: Check coverage minimum
        run: sbt "project core" coverageAggregate
