name: CI

on:
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 17
          cache: sbt

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      # Scalafmt: Formatting (whitespace, indentation, import order)
      - name: Check formatting (scalafmt)
        run: sbt scalafmtCheckAll

      # Scalastyle: Style rules (naming, complexity, method length)
      - name: Check style (scalastyle)
        run: sbt scalastyle

      # Scalafix: Semantic linting (unused imports/vars, dangerous patterns)
      - name: Check semantic rules (scalafix)
        run: sbt "scalafixAll --check"

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 17
          cache: sbt

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      # OWASP Dependency Check: Scan dependencies for known CVEs
      # Requires NVD API key (free): https://nvd.nist.gov/developers/request-an-api-key
      # Suppression file: dependency-check-suppressions.xml (false positives documented)
      - name: OWASP Dependency Check
        continue-on-error: true
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          if [ -n "$NVD_API_KEY" ]; then
            sbt -Danalyzer.nist.nvd.api.key="$NVD_API_KEY" \
                -Dsuppression="$PWD/dependency-check-suppressions.xml" \
                dependencyCheck
          else
            echo "::warning::NVD_API_KEY not configured. Add secret to enable vulnerability scanning."
            echo "Register for free API key at: https://nvd.nist.gov/developers/request-an-api-key"
            exit 1
          fi

      - name: Upload OWASP report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: owasp-report
          path: target/dependency-check-report.html
          retention-days: 30

  test-spark3:
    name: Test (Spark 3 / Scala 2.12)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 17
          cache: sbt

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      - name: Run tests with coverage
        run: sbt coverage "project core2_12" test "project runtimespark32_12" test "project runnerspark32_12" test "project examplespark32_12" test coverageReport

      - name: Check coverage minimum
        run: sbt "project core2_12" coverageAggregate

  test-spark3-scala213:
    name: Test (Spark 3 / Scala 2.13)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 17
          cache: sbt

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      - name: Run tests with coverage
        run: sbt coverage "project core" test "project runtimespark3" test "project runnerspark3" test "project examplespark3" test coverageReport

      - name: Check coverage minimum
        run: sbt "project core" coverageAggregate

  test-spark4:
    name: Test (Spark 4 / Scala 2.13)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 17
          cache: sbt

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      - name: Run tests with coverage
        run: sbt coverage "project core" test "project runtimespark4" test "project runnerspark4" test "project examplespark4" test coverageReport

      - name: Check coverage minimum
        run: sbt "project core" coverageAggregate
